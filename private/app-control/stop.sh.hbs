if [ "$(whoami)" != "root" ]; then
  echo "Stop script should be executed with root privileges."
  exit 1
fi

#
# GENERAL STATE CLEANUP AND CONFIGURATION+
#

# Root data directory is {{dataDir}}
PROJECT="{{project}}"
APPNAME="{{appName}}"
INSTANCE="{{instance}}"
DASHBOARD_URL={{dashboardUrl}}/api/v1/state/$INSTANCE

# Setup docker environment
swarmPath=/swarm/swarm.sock
dockerPath=$(which docker)
[ -a $swarmPath ] {{{literal '&'}}}{{{literal '&'}}} swarmLeader=unix:///swarm/sock.sock
if [[ -a $swarmPath ]]; then swarmLeader=unix://$swarmPath; DOCKER="$dockerPath -H $swarmLeader"; else DOCKER="$dockerPath"; fi

TOTAL_STEPS=$((({{total}}*2)+1))
STEP=0

curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
	\"meta\": { \
		\"state\": \"stopping\", \
		\"totalSteps\": \"$TOTAL_STEPS\", \
		\"progress\": \"$STEP\" \
	} \
}"

{{#each reverse services}}
  DOCKERNAME="{{service}}-$PROJECT-$INSTANCE"
  DOCKERNETNAME="net-$DOCKERNAME"
  DOCKERSSHDNAME="sshd-$DOCKERNAME"

  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"stateDescription\": \"Stopping service {{service}}\", \
      \"progress\": \"$STEP\" \
    } \
  }"
  STEP=$((STEP+1))
  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"progress\": \"$STEP\" \
    } \
  }"

  $DOCKER stop $DOCKERNETNAME
  $DOCKER rm -v $DOCKERNETNAME
  $DOCKER stop -t 10 $DOCKERSSHDNAME
  $DOCKER rm -v $DOCKERSSHDNAME
  $DOCKER stop -t 30 $DOCKERNAME
  $DOCKER rm -v $DOCKERNAME

{{/each}}

curl -XDELETE -sS $DASHBOARD_URL
