if [ "$(whoami)" != "root" ]; then
  echo "Stop script should be executed with root privileges."
  exit 1
fi

# Setup docker environment
swarmLeader=$(etcdctl --peers=http://10.25.55.11:4001 get /docker/swarm/leader)
dockerPath=$(which docker)
DOCKER="$dockerPath -H $swarmLeader"

PROJECT="{{project}}"
APPNAME="{{appName}}"
INSTANCE="{{instance}}"
TOTAL_STEPS=$((({{total}}*2)+1))
STEP=0

DASHBOARD_URL={{dashboardUrl}}/api/v1/state/$INSTANCE

curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
	\"meta\": { \
		\"state\": \"stopping\", \
		\"totalSteps\": \"$TOTAL_STEPS\", \
		\"progress\": \"$STEP\" \
	} \
}"

{{#each reverse services}}
  DOCKERNAME="{{service}}-$PROJECT-$INSTANCE"
  DOCKERSSHDNAME="sshd-$DOCKERNAME"


  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"stateDescription\": \"Stopping service {{service}}\", \
      \"progress\": \"$STEP\" \
    } \
  }"
  STEP=$((STEP+1))
  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"progress\": \"$STEP\" \
    } \
  }"
  $DOCKER stop -t 10 $DOCKERSSHDNAME
  $DOCKER rm -v $DOCKERSSHDNAME
  $DOCKER stop -t 30 $DOCKERNAME
  $DOCKER rm -v $DOCKERNAME

{{/each}}

curl -XDELETE -sS $DASHBOARD_URL
