if [ "$(whoami)" != "root" ]; then
  echo "Stop script should be executed with root privileges."
  exit 1
fi

PROJECT="{{project}}"
APPNAME="{{appName}}"
INSTANCE="{{instance}}"
TOTAL_STEPS=$((({{total}}*2)+1))
STEP=0

DASHBOARD_URL={{dashboardUrl}}/api/v1/state/$INSTANCE

curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
	\"meta\": { \
		\"state\": \"stopping\", \
		\"totalSteps\": \"$TOTAL_STEPS\", \
		\"progress\": \"$STEP\" \
	} \
}"

{{#each reverse services}}
  DOCKERNAME="{{service}}-$PROJECT-$INSTANCE"
  DOCKERNETNAME="net-$DOCKERNAME"
  DOCKERSSHDNAME="sshd-$DOCKERNAME"

  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
  	\"meta\": { \
  		\"stateDescription\": \"Stopping network for {{service}}\" \
  	} \
  }"

  STEP=$((STEP+1))
  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"progress\": \"$STEP\" \
    } \
  }"

  docker stop -t 5 $DOCKERNETNAME
  docker rm -v $DOCKERNETNAME

  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"stateDescription\": \"Stopping service {{service}}\", \
      \"progress\": \"$STEP\" \
    } \
  }"
  STEP=$((STEP+1))
  curl -XPUT -sS $DASHBOARD_URL -H "Content-Type: application/json" -d "{ \
    \"meta\": { \
      \"progress\": \"$STEP\" \
    } \
  }"
  docker stop -t 10 $DOCKERSSHDNAME
  docker rm -v $DOCKERSSHDNAME
  docker stop -t 30 $DOCKERNAME
  docker rm -v $DOCKERNAME

{{/each}}

curl -XDELETE -sS $DASHBOARD_URL
