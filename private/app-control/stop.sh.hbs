PROJECT="{{project}}"
APPNAME="{{appName}}"
INSTANCE="{{instance}}"
ETCD_CLUSTER="{{etcdCluster}}"
ETCD_INSTANCE_KEY="/instances/$PROJECT/$APPNAME/$INSTANCE"

etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/state "stopping"

{{#each services}}
  DOCKERNAME="{{service}}-$PROJECT-$INSTANCE"
  DOCKERNETNAME="net-$DOCKERNAME"

  myip=$(docker exec $DOCKERNETNAME ifconfig eth1 | grep "inet addr:" | awk '{print $2}' | awk -F: '{print $2}')
  route del -host $myip docker0
  docker stop -t 5 $DOCKERNETNAME
  docker rm $DOCKERNETNAME
  docker stop -t 30 $DOCKERNAME
  docker rm $DOCKERNAME
  etcdctl --peers $ETCD_CLUSTER rm /skydns/ictu/$PROJECT/$INSTANCE/{{service}}

{{/each}}

etcdctl --peers $ETCD_CLUSTER rm $ETCD_INSTANCE_KEY --recursive
