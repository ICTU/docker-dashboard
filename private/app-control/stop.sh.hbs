if [ "$(whoami)" != "root" ]; then
  echo "Stop script should be executed with root privileges."
  exit 1
fi

PROJECT="{{project}}"
APPNAME="{{appName}}"
INSTANCE="{{instance}}"
ETCD_CLUSTER="{{etcdCluster}}"
ETCD_INSTANCE_KEY="/instances/$PROJECT/$APPNAME/$INSTANCE"
TOTAL_STEPS=$((({{total}}*2)+1))
STEP=1

etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/state "stopping"
etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/totalSteps "$TOTAL_STEPS"
etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/progress "$STEP"

{{#each services}}
  DOCKERNAME="{{service}}-$PROJECT-$INSTANCE"
  DOCKERNETNAME="net-$DOCKERNAME"

  myip=$(docker exec $DOCKERNETNAME ifconfig eth1 | grep "inet addr:" | awk '{print $2}' | awk -F: '{print $2}')
  etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/stateDescription "Stopping network for {{service}}"
  etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/progress "$STEP"
  STEP=$((STEP+1))
  route del -host $myip docker0
  docker stop -t 5 $DOCKERNETNAME
  docker rm $DOCKERNETNAME
  etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/stateDescription "Stopping {{service}}"
  etcdctl --peers $ETCD_CLUSTER set $ETCD_INSTANCE_KEY/meta_/progress "$STEP"
  STEP=$((STEP+1))
  docker stop -t 30 $DOCKERNAME
  docker rm $DOCKERNAME
  etcdctl --peers $ETCD_CLUSTER rm /skydns/ictu/$PROJECT/$INSTANCE/{{service}}

{{/each}}

etcdctl --peers $ETCD_CLUSTER rm $ETCD_INSTANCE_KEY --recursive
